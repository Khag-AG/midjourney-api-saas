<!DOCTYPE html>
<html>
<head>
    <title>Midjourney API - –°—É–ø–µ—Ä –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; border-radius: 16px; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: white; padding: 25px; border-radius: 16px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid transparent;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 30px rgba(0,0,0,0.15);
        }
        
        .stat-card.primary { border-color: #667eea; }
        .stat-card.success { border-color: #48bb78; }
        .stat-card.warning { border-color: #ed8936; }
        .stat-card.danger { border-color: #f56565; }
        
        .stat-icon { font-size: 2rem; margin-bottom: 10px; }
        .stat-number { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
        .stat-label { color: #718096; font-size: 0.9rem; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { 
            background: white; border-radius: 16px; padding: 30px; margin-bottom: 25px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
        }
        
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;
        }
        
        .card h2 { color: #2d3748; font-size: 1.8rem; }
        
        /* –¢–∞–±—ã */
        .tabs {
            display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0;
        }
        
        .tab {
            padding: 12px 24px; cursor: pointer; border-radius: 8px 8px 0 0;
            transition: all 0.3s ease; font-weight: 600;
        }
        
        .tab:hover { background: #f7fafc; }
        .tab.active { 
            background: #667eea; color: white;
            box-shadow: 0 -3px 10px rgba(102, 126, 234, 0.3);
        }
        
        /* –§–æ—Ä–º—ã */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { 
            display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        .form-input, .form-select { 
            width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 14px; transition: all 0.3s ease;
        }
        
        .form-input:focus, .form-select:focus { 
            outline: none; border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { 
            padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease; text-decoration: none;
            display: inline-block; text-align: center; font-size: 14px;
        }
        
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover { background: #38a169; transform: translateY(-2px); }
        
        .btn-warning { background: #ed8936; color: white; }
        .btn-warning:hover { background: #dd6b20; transform: translateY(-2px); }
        
        .btn-danger { background: #f56565; color: white; }
        .btn-danger:hover { background: #e53e3e; transform: translateY(-2px); }
        
        .btn-sm { padding: 8px 16px; font-size: 12px; }
        
        /* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ */
        .user-card { 
            border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin: 15px 0;
            background: #f8fafc; transition: all 0.3s ease; position: relative;
        }
        
        .user-card:hover { border-color: #667eea; background: white; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        
        .user-card.blocked { background: #fed7d7; border-color: #fc8181; }
        .user-card.admin { background: #e9d8fd; border-color: #b794f4; }
        
        .user-header { 
            display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;
        }
        
        .user-info { flex: 1; }
        .user-email { font-size: 1.2rem; font-weight: bold; color: #2d3748; margin-bottom: 5px; }
        .user-role { 
            display: inline-block; padding: 4px 12px; border-radius: 20px; 
            font-size: 0.8rem; font-weight: bold; margin-left: 10px;
        }
        .role-admin { background: #9f7aea; color: white; }
        .role-user { background: #4299e1; color: white; }
        
        .user-status { 
            padding: 6px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;
        }
        .status-active { background: #c6f6d5; color: #22543d; }
        .status-blocked { background: #fed7d7; color: #742a2a; }
        
        .user-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        .detail-group { 
            background: white; padding: 15px; border-radius: 8px; 
            border-left: 4px solid #667eea;
        }
        
        .detail-label { font-weight: 600; color: #718096; margin-bottom: 5px; font-size: 0.85rem; }
        .detail-value { 
            font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9rem; 
            color: #2d3748; word-break: break-all;
        }
        
        .user-actions { 
            display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;
        }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-bar { 
            background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden; 
            margin: 10px 0; position: relative;
        }
        
        .progress-fill { 
            height: 100%; background: linear-gradient(90deg, #48bb78, #38a169); 
            transition: width 0.3s ease; position: relative;
        }
        
        .progress-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 0.7rem; font-weight: bold; color: #2d3748;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-content { 
            background: white; margin: 5% auto; padding: 40px; border-radius: 16px;
            max-width: 600px; position: relative; animation: slideIn 0.3s ease;
            max-height: 80vh; overflow-y: auto;
        }
        
        @keyframes slideIn { 
            from { transform: translateY(-50px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close { 
            position: absolute; top: 20px; right: 25px; font-size: 28px; 
            cursor: pointer; color: #718096; transition: color 0.3s ease;
        }
        .close:hover { color: #2d3748; }
        
        /* –ò—Å—Ç–æ—Ä–∏—è */
        .history-item {
            background: #f7fafc; padding: 15px; border-radius: 8px; margin: 10px 0;
            border-left: 3px solid #667eea;
        }
        
        .history-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .history-time { color: #718096; font-size: 0.85rem; }
        
        /* –ê–ª–µ—Ä—Ç—ã */
        .alert { 
            padding: 16px 20px; border-radius: 10px; margin: 15px 0; 
            display: flex; align-items: center; gap: 10px;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .alert-success { background: #c6f6d5; border: 1px solid #9ae6b4; color: #22543d; }
        .alert-error { background: #fed7d7; border: 1px solid #fc8181; color: #742a2a; }
        .alert-warning { background: #feebc8; border: 1px solid #f6ad55; color: #744210; }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading { 
            display: inline-block; width: 20px; height: 20px; 
            border: 3px solid #f3f3f3; border-top: 3px solid #667eea;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å */
        .switch {
            position: relative; display: inline-block; width: 50px; height: 24px;
        }
        
        .switch input { opacity: 0; width: 0; height: 0; }
        
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e0; transition: .4s; border-radius: 24px;
        }
        
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 4px;
            bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
        }
        
        input:checked + .slider { background-color: #48bb78; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .user-details { grid-template-columns: 1fr; }
            .modal-content { margin: 10% 20px; padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üé® Midjourney API - –°—É–ø–µ—Ä –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h1>
            <p>–ü–æ–ª–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –ª–∏–º–∏—Ç–∞–º–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è–º–∏</p>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-icon">üë•</div>
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card success">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-number" id="activeUsers">0</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-icon">üîí</div>
                <div class="stat-number" id="blockedUsers">0</div>
                <div class="stat-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-icon">üëë</div>
                <div class="stat-number" id="adminUsers">0</div>
                <div class="stat-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üé®</div>
                <div class="stat-number" id="totalGenerations">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-number" id="totalLimits">0</div>
                <div class="stat-label">–û–±—â–∏–π –ª–∏–º–∏—Ç</div>
            </div>
        </div>

        <!-- –¢–∞–±—ã -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div class="tab" onclick="showTab('create')">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <div class="tab" onclick="showTab('history')">üìú –ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        <div id="users-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                    <button onclick="loadUsers()" class="btn btn-success">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select id="filterRole" onchange="filterUsers()" class="form-select" style="width: auto;">
                        <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                    </select>
                    <select id="filterStatus" onchange="filterUsers()" class="form-select" style="width: auto;">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                    </select>
                    <input type="text" id="searchUser" placeholder="–ü–æ–∏—Å–∫ –ø–æ email..." class="form-input" style="width: 300px;" onkeyup="filterUsers()">
                </div>
                
                <div id="usersList"></div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div id="create-tab" class="tab-content" style="display: none;">
            <div class="card">
                <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <form id="createUserForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">üìß Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <input type="email" id="userEmail" class="form-input" placeholder="user@example.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üë§ –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <select id="userRole" class="form-select" onchange="toggleLimitInput()">
                                <option value="user">–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                                <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–±–µ–∑ –ª–∏–º–∏—Ç–æ–≤)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" id="limitGroup">
                        <label class="form-label">üìä –ú–µ—Å—è—á–Ω—ã–π –ª–∏–º–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</label>
                        <input type="number" id="monthlyLimit" class="form-input" value="50" min="1" max="10000">
                    </div>
                    
                    <h3 style="margin: 30px 0 20px 0; color: #4a5568;">üîß Discord –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">üè† Discord Server ID</label>
                            <input type="text" id="serverId" class="form-input" placeholder="1378677603203813386" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üí¨ Discord Channel ID</label>
                            <input type="text" id="channelId" class="form-input" placeholder="1378677603203813389" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üîë Discord User Token</label>
                        <input type="text" id="salaiToken" class="form-input" placeholder="MTM3ODY3NTgwOTE5NTEzMDkwMQ..." required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 16px; margin-top: 20px;">
                        ‚ú® –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </button>
                </form>
                <div id="createResult"></div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ò—Å—Ç–æ—Ä–∏—è -->
        <div id="history-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h2>
                    <button onclick="loadHistory()" class="btn btn-success">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <form id="editForm">
                <input type="hidden" id="editApiKey">
                <div class="form-group">
                    <label class="form-label">üìß Email</label>
                    <input type="email" id="editEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">üë§ –†–æ–ª—å</label>
                    <select id="editRole" class="form-select" onchange="toggleEditLimit()">
                        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <div class="form-group" id="editLimitGroup">
                    <label class="form-label">üìä –ú–µ—Å—è—á–Ω—ã–π –ª–∏–º–∏—Ç</label>
                    <input type="number" id="editLimit" class="form-input" min="1" max="10000">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </form>
        </div>
    </div>

    <script>
        let allUsers = [];

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            
            if (tabName === 'history') loadHistory();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ä–æ–ª–∏
        function toggleLimitInput() {
            const role = document.getElementById('userRole').value;
            document.getElementById('limitGroup').style.display = role === 'admin' ? 'none' : 'block';
        }

        function toggleEditLimit() {
            const role = document.getElementById('editRole').value;
            document.getElementById('editLimitGroup').style.display = role === 'admin' ? 'none' : 'block';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const response = await fetch('/admin/users');
                const data = await response.json();
                allUsers = data.users;
                
                updateStats(data.users);
                filterUsers();
                
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message, 'error');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats(users) {
            let activeCount = 0, blockedCount = 0, adminCount = 0;
            let totalGenerations = 0, totalLimits = 0;
            
            users.forEach(user => {
                if (user.status === 'active') activeCount++;
                if (user.status === 'blocked') blockedCount++;
                if (user.role === 'admin') adminCount++;
                totalGenerations += user.currentUsage || 0;
                if (user.monthlyLimit > 0) totalLimits += user.monthlyLimit;
            });
            
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeUsers').textContent = activeCount;
            document.getElementById('blockedUsers').textContent = blockedCount;
            document.getElementById('adminUsers').textContent = adminCount;
            document.getElementById('totalGenerations').textContent = totalGenerations;
            document.getElementById('totalLimits').textContent = totalLimits;
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function filterUsers() {
            const roleFilter = document.getElementById('filterRole').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const searchFilter = document.getElementById('searchUser').value.toLowerCase();
            
            const filteredUsers = allUsers.filter(user => {
                if (roleFilter && user.role !== roleFilter) return false;
                if (statusFilter && user.status !== statusFilter) return false;
                if (searchFilter && !user.email.toLowerCase().includes(searchFilter)) return false;
                return true;
            });
            
            displayUsers(filteredUsers);
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            if (users.length === 0) {
                usersList.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            users.forEach(user => {
                const progressPercent = user.monthlyLimit > 0 ? (user.currentUsage / user.monthlyLimit) * 100 : 0;
                const isAdmin = user.role === 'admin';
                const isBlocked = user.status === 'blocked';
                
                const userDiv = document.createElement('div');
                userDiv.className = `user-card ${isBlocked ? 'blocked' : ''} ${isAdmin ? 'admin' : ''}`;
                userDiv.innerHTML = `
                    <div class="user-header">
                        <div class="user-info">
                            <div>
                                <span class="user-email">üìß ${user.email}</span>
                                <span class="user-role role-${user.role}">${user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span>
                            </div>
                            <div style="margin-top: 5px;">
                                <span class="user-status status-${user.status}">${user.status === 'active' ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-details">
                        <div class="detail-group">
                            <div class="detail-label">üîë API –∫–ª—é—á</div>
                            <div class="detail-value">${user.apiKey.substring(0, 20)}...</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</div>
                            <div class="detail-value">
                                ${isAdmin ? '‚ôæÔ∏è –ë–µ–∑–ª–∏–º–∏—Ç' : `${user.currentUsage} / ${user.monthlyLimit}`}
                            </div>
                            ${!isAdmin ? `
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                </div>
                                <small>–û—Å—Ç–∞–ª–æ—Å—å: ${user.monthlyLimit - user.currentUsage}</small>
                            ` : ''}
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">üìÖ –°–æ–∑–¥–∞–Ω</div>
                            <div class="detail-value">${new Date(user.createdAt).toLocaleString('ru-RU')}</div>
                        </div>
                    </div>
                    
                    <div class="user-actions">
                        <button onclick="showUserDetails('${user.apiKey}')" class="btn btn-primary btn-sm">üîç –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</button>
                        <button onclick="editUser('${user.apiKey}')" class="btn btn-warning btn-sm">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button onclick="toggleBlock('${user.apiKey}')" class="btn ${user.status === 'active' ? 'btn-danger' : 'btn-success'} btn-sm">
                            ${user.status === 'active' ? 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                        </button>
                        ${!isAdmin ? `<button onclick="resetLimits('${user.apiKey}')" class="btn btn-success btn-sm">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã</button>` : ''}
                        <button onclick="deleteUser('${user.apiKey}')" class="btn btn-danger btn-sm">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                usersList.appendChild(userDiv);
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function showUserDetails(apiKey) {
            try {
                const response = await fetch(`/admin/users/${apiKey}`);
                const user = await response.json();
                
                const historyHtml = user.history && user.history.length > 0 
                    ? user.history.map(item => `
                        <div class="history-item">
                            <div class="history-header">
                                <strong>${item.prompt}</strong>
                                <span class="history-time">${new Date(item.timestamp).toLocaleString('ru-RU')}</span>
                            </div>
                            <a href="${item.imageUrl}" target="_blank" class="btn btn-primary btn-sm">üñºÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
                        </div>
                    `).join('')
                    : '<p>–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</p>';
                
                document.getElementById('modalContent').innerHTML = `
                    <h2>üë§ –î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                    
                    <div class="detail-group">
                        <div class="detail-label">üìß Email</div>
                        <div class="detail-value">${user.userEmail}</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">üë§ –†–æ–ª—å</div>
                        <div class="detail-value">${user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">‚ö° –°—Ç–∞—Ç—É—Å</div>
                        <div class="detail-value">${user.status === 'active' ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">üîë API –∫–ª—é—á</div>
                        <div class="detail-value">${user.apiKey}</div>
                        <button onclick="copyToClipboard('${user.apiKey}')" class="btn btn-success btn-sm" style="margin-top: 10px;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    
                    <h3 style="margin: 30px 0 15px 0;">üîß Discord –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    
                    <div class="detail-group">
                        <div class="detail-label">üè† Server ID</div>
                        <div class="detail-value">${user.serverId}</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">üí¨ Channel ID</div>
                        <div class="detail-value">${user.channelId}</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">üîê User Token</div>
                        <div class="detail-value">${user.salaiToken.substring(0, 30)}...</div>
                    </div>
                    
                    <h3 style="margin: 30px 0 15px 0;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    
                    <div class="detail-group">
                        <div class="detail-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div>
                        <div class="detail-value">${user.currentUsage || 0}</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">–ú–µ—Å—è—á–Ω—ã–π –ª–∏–º–∏—Ç</div>
                        <div class="detail-value">${user.monthlyLimit === -1 ? '‚ôæÔ∏è –ë–µ–∑–ª–∏–º–∏—Ç' : user.monthlyLimit}</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">–î–∞—Ç–∞ —Å–±—Ä–æ—Å–∞</div>
                        <div class="detail-value">${user.resetDate ? new Date(user.resetDate).toLocaleDateString('ru-RU') : '–ù/–î'}</div>
                    </div>
                    
                    <h3 style="margin: 30px 0 15px 0;">üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h3>
                    ${historyHtml}
                `;
                
                document.getElementById('userModal').style.display = 'block';
                
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π: ' + error.message, 'error');
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function editUser(apiKey) {
            const user = allUsers.find(u => u.apiKey === apiKey);
            if (!user) return;
            
            document.getElementById('editApiKey').value = apiKey;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editRole').value = user.role || 'user';
            document.getElementById('editLimit').value = user.monthlyLimit;
            
            toggleEditLimit();
            document.getElementById('editModal').style.display = 'block';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const apiKey = document.getElementById('editApiKey').value;
            const updates = {
                userEmail: document.getElementById('editEmail').value,
                role: document.getElementById('editRole').value,
                monthlyLimit: document.getElementById('editRole').value === 'admin' 
                    ? -1 
                    : parseInt(document.getElementById('editLimit').value)
            };
            
            try {
                const response = await fetch(`/admin/users/${apiKey}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                    closeEditModal();
                    loadUsers();
                } else {
                    showAlert('‚ùå –û—à–∏–±–∫–∞: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
        async function toggleBlock(apiKey) {
            try {
                const response = await fetch(`/admin/users/${apiKey}/toggle-block`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${result.status === 'blocked' ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}!`, 'success');
                    loadUsers();
                }
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –°–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤
        async function resetLimits(apiKey) {
            if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ 0?')) return;
            
            try {
                const response = await fetch(`/admin/users/${apiKey}/reset`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ –õ–∏–º–∏—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã!', 'success');
                    loadUsers();
                }
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function deleteUser(apiKey) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) return;
            
            try {
                const response = await fetch(`/admin/users/${apiKey}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω!', 'success');
                    loadUsers();
                }
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const role = document.getElementById('userRole').value;
            const userData = {
                userEmail: document.getElementById('userEmail').value,
                serverId: document.getElementById('serverId').value,
                channelId: document.getElementById('channelId').value,
                salaiToken: document.getElementById('salaiToken').value,
                monthlyLimit: role === 'admin' ? -1 : parseInt(document.getElementById('monthlyLimit').value),
                role: role
            };
            
            try {
                const response = await fetch('/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`‚úÖ ${role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} —Å–æ–∑–¥–∞–Ω!<br>üîë API –∫–ª—é—á: <strong>${result.apiKey}</strong>`, 'success');
                    document.getElementById('createUserForm').reset();
                    loadUsers();
                    copyToClipboard(result.apiKey);
                } else {
                    showAlert('‚ùå –û—à–∏–±–∫–∞: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        async function loadHistory() {
            try {
                const response = await fetch('/admin/history');
                const data = await response.json();
                
                const historyList = document.getElementById('historyList');
                
                if (data.history.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
                    return;
                }
                
                historyList.innerHTML = data.history.map(item => `
                    <div class="history-item">
                        <div class="history-header">
                            <div>
                                <strong>üìß ${item.userEmail}</strong>
                                <span style="color: #718096; margin-left: 10px;">API: ${item.apiKey}</span>
                            </div>
                            <span class="history-time">${new Date(item.timestamp).toLocaleString('ru-RU')}</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>–ü—Ä–æ–º–ø—Ç:</strong> ${item.prompt}
                        </div>
                        <a href="${item.imageUrl}" target="_blank" class="btn btn-primary btn-sm">üñºÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</a>
                    </div>
                `).join('');
                
            } catch (error) {
                showAlert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message, 'error');
            }
        }

        // –£—Ç–∏–ª–∏—Ç—ã
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            });
        }

        function closeModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            document.getElementById('createResult').innerHTML = '';
            document.getElementById('createResult').appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadUsers();
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadUsers, 30000);
    </script>
</body>
</html>